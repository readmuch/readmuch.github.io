<!DOCTYPE html>
<html lang="en">
    <script>
    (async function() {
        // Load site config once so we can build nav and resolve category back links
        let cfg = null;
        try {
            cfg = new SiteConfig();
            await cfg.load();
            const nav = document.getElementById('siteNav');
            cfg.get().categories.forEach(cat => {
                const a = document.createElement('a');
                a.className = 'tab';
                a.href = cat.file;
                a.textContent = cat.title;
                nav.appendChild(a);
            });
        } catch (e) {
            console.error('Failed to load site config for nav', e);
        }

        // Parse ?src=... parameter
        const params = new URLSearchParams(location.search);
        const src = params.get('src');
        if (!src) {
            document.getElementById('postTitle').textContent = 'Post not found';
            document.getElementById('postContent').textContent = 'No source specified.';
            return;
        }

        // Insert a back-link placeholder; we'll populate href/text once category is known
        const articleHeader = document.querySelector('#postArticle > header');
        const backLink = document.createElement('a');
        backLink.id = 'backLink';
        backLink.className = 'back-link';
        backLink.style.display = 'inline-block';
        backLink.style.marginBottom = '12px';
        backLink.href = 'index.html';
        backLink.textContent = '← Back';
        if (articleHeader) articleHeader.insertBefore(backLink, articleHeader.firstChild);

        try {
            const res = await fetch(src);
            if (!res.ok) throw new Error('Not found');
            const md = await res.text();
            // Extract title
            const titleMatch = md.match(/^\s*#\s+(.+?)\s*$/m);
            const title = titleMatch ? titleMatch[1].trim() : '';
            document.getElementById('postTitle').textContent = title || 'Untitled';

            // Render markdown to HTML
            const html = marked.parse(md);
            document.getElementById('postContent').innerHTML = html;

            // Optional: set meta (date) from file-dates.json
            try {
                const dates = await fetch('config/file-dates.json').then(r => r.json());
                const date = dates[src] || '';
                if (date) document.getElementById('postMeta').textContent = date;
            } catch (e) {}

            // Determine category from src path (e.g., 'Tech/youpaper.md' -> 'Tech')
            if (cfg && cfg.get && src.includes('/')) {
                const dir = src.split('/')[0] || '';
                const catId = dir.toLowerCase();
                const category = cfg.get().categories.find(c => c.id === catId || c.title.toLowerCase() === catId);
                if (category) {
                    backLink.href = category.file || 'index.html';
                    backLink.textContent = `← Back to ${category.title}`;
                }
            }

        } catch (err) {
            document.getElementById('postTitle').textContent = 'Failed to load post';
            document.getElementById('postContent').textContent = '' + err;
            console.error(err);
        }
    })();
    </script>
                const date = dates[src] || '';
                if (date) document.getElementById('postMeta').textContent = date;
            } catch (e) {}

        } catch (err) {
            document.getElementById('postTitle').textContent = 'Failed to load post';
            document.getElementById('postContent').textContent = '' + err;
            console.error(err);
        }
    })();
    </script>
</body>
</html>
